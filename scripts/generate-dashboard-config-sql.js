#!/usr/bin/env node
/**
 * Generates SQL UPDATE statements from config/dashboard_configurations.json
 * for workspace_dashboard_configurations.dashboard_config.
 *
 * Usage:
 *   node scripts/generate-dashboard-config-sql.js
 *   node scripts/generate-dashboard-config-sql.js > config/dashboard_config_updates.sql
 *
 * Edit config/dashboard_configurations.json, then run this script and execute
 * the output SQL via Supabase SQL editor or: supabase db execute -f config/dashboard_config_updates.sql
 */

const fs = require('fs');
const path = require('path');

const CONFIG_PATH = path.join(__dirname, '..', 'config', 'dashboard_configurations.json');
const OUTPUT_PATH = path.join(__dirname, '..', 'config', 'dashboard_config_updates.sql');

function escapeSqlString(str) {
  return str.replace(/'/g, "''");
}

function main() {
  let config;
  try {
    const raw = fs.readFileSync(CONFIG_PATH, 'utf8');
    config = JSON.parse(raw);
  } catch (err) {
    console.error('Failed to read config:', err.message);
    process.exit(1);
  }

  const statements = [];
  statements.push('-- Generated by scripts/generate-dashboard-config-sql.js');
  statements.push('-- Run via Supabase SQL editor or: supabase db execute -f config/dashboard_config_updates.sql');
  statements.push('');

  for (const [configName, dashboardConfig] of Object.entries(config)) {
    if (typeof dashboardConfig !== 'object' || dashboardConfig === null) {
      console.warn(`Skipping invalid entry for config_name: ${configName}`);
      continue;
    }
    const jsonStr = JSON.stringify(dashboardConfig);
    const escaped = escapeSqlString(jsonStr);
    statements.push(`-- Update ${configName}`);
    statements.push(`UPDATE workspace_dashboard_configurations`);
    statements.push(`SET dashboard_config = '${escaped}'::jsonb`);
    statements.push(`WHERE config_name = '${escapeSqlString(configName)}';`);
    statements.push('');
  }

  const sql = statements.join('\n');

  if (process.argv.includes('--stdout') || process.argv.includes('-o')) {
    process.stdout.write(sql);
  } else {
    fs.writeFileSync(OUTPUT_PATH, sql, 'utf8');
    console.log(`Wrote ${OUTPUT_PATH}`);
  }
}

main();
